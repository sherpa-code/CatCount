<!DOCTYPE html>
<!--
  author: Jo Crane
  
  'Cat Count' is an interactive single-page web application using HTML, CSS, and JavaScript.
  The goal is to search your apartment (by clicking) all areas in which your cats may be hiding to find them all before the timer expires.
  
  TODO: separate the cat gif from its parent container so that, upon victory or failure, they don't just disappear at that moment.
  TODO: after the clickable areas are mapped properly to the background images, remove the grey colors and row outlines from them
  TODO: add to Github Pages
  TODO: center the success and failure message modals
  TODO: add responsiveness via Media Queries for at least 720p and 1080p
-->
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Cat Count!</title>
        <link rel="stylesheet" href="styles.css" />
    </head>
    
    <body>
        <section id="splashPage">
            <div class="container">
            <!-- <div class="container.splashImageContainer"> -->
                <dialog id="splashTitle">
                    <h1>Cat Count!</h1>
                </dialog>

                <dialog id="instructions">
                    <h1><u>Find Your Kitties!</u></h1>
                    <p>You are about to leave for work in a hurry...</p>
                    <p>but you haven't made sure all your cats haven't gotten into sticky situations!</p>
                    <p>
                        Check every place they could be hiding before the clock runs out or you might be <b><u>late for work!</u></b>
                    </p>
                    <div id="startGameContainer">
                        <button id="startGameButton" onclick="startGame()" font-size="200%">Start</button>
                    </div>
                </dialog>

                <div id="letsGoButtonContainer">
                    <button id="letsGoButton" onclick="showInstructions()">
                        <p>Let's go!</p>
                    </button>
                </div>
            </div>
        </section>

        
        <main id="playArea">
            <section id="imageMapContainer"> 
                <img src="img/kitchen.jpg" alt="Location Image" usemap="#imageMap" style="width: 100%; height: auto;">
        
                <map name="imageMap" display="">
                    <!-- Define clickable areas using vh and vw units as coordinates -->
                    <area shape="rect" coords="100,100,100,100" width="100px" height="100px" href="https://example.com/area1" alt="Area 1">
                    <!-- <area shape="rect" coords="20vw,5vh,30vw,15vh" href="https://example.com/area2" alt="Area 2"> -->
                </map>
                <nav id="goToBedroomButton" class="goToLocationButton area--clickable" onclick="goToLocation('bedroom')">&#9666; To the Bedroom</nav>
                <nav id="goToKitchenButton" class="goToLocationButton area--clickable" onclick="goToLocation('kitchen')">To the Kitchen &#9656;</nav>
                <section class="row row__stats">
                    <p id="timer" class="stats--display">Timer: <span id="timerValue"></span></p>
                    <p id="foundCounter" class="stats--display">Found: <span id="foundCounterValue">0</span>/3</p> <!-- TODO: change the total to be whatever the javascript totalCats count is-->
                </section>
            </section>

            <dialog class="success finalDialog" id="successMessage">
                You found all of your cats, now head to work!</br>&#128526;
            </dialog>

            <dialog class="failure finalDialog" id="failureMessage">
                You didn't find your cats in time... Oh no! You'll be late!<br>&#129402;
            </dialog>
        </main>
            
        <script>
            // Graphics and UI
            // const playArea = document.getElementsByTagName("main")[0]; // the primary container in the body
            const instructions = document.getElementById("instructions");
            const splashPage = document.getElementById("splashPage");
            const catImages = [];
            const frownEmoji = '\uD83D\uDE41';
            const heartEmoji = '\u2764\uFE0F';
            const interval = 150; // Adjust the interval (in milliseconds) for adding emojis to the window at the end

            const fadeIn = "fadeIn 0.5s ease-in forwards";
            const fadeOut = "fadeOut 0.5s ease-out forwards";
            const fadeInOut = 'fadeInOut 2s ease-in-out forwards';
            
            // Statistics
            let clickCounter = 0;
            let timer = 90;
            // let timer = 4;
            var catsFound = 0;
            let totalCats = 3;
            
            // Areas
            var clickedAreas = [];
            var catLocations = [];
            var areaNames = ["that cupboard", "that drawer", "the sink", "the curtain", "the closet"];
            
            // Interactables
            var goToBedroomButton = document.getElementById("goToBedroomButton");
            var goToKitchenButton = document.getElementById("goToKitchenButton");
            
            // TODO: write function to add all CLICKABLE areas in the image map to an array;
            // Note: replaces below code
            
            // // When DOM is fully loaded // NOTE: disabled while converting to map version
            // document.addEventListener("DOMContentLoaded", function () {
            //     let allAreaNodes = document.querySelectorAll('[id^="area_"]'); // Into allAreaNodes NodeList, place all elements with id starting with "area_"
            //     console.log('%c%s', 'background-color:grey; color:orange', 'allAreaNodes = ' + allAreaNodes);
            //     arrayFromClickables = Array.from(allAreaNodes); // Convert NodeList to Array (for better manipulation)
            //     // console.log("%c%s", "background-color:grey; color:orange",
            //     // 'Elements with id beginning "area_" converted from NodeList to an array are: ' + arrayFromClickables);
                
            //     allAreaNodes.forEach((e) => {
            //         e.addEventListener("click", checkAddClickedAreaToArray);
            //     });
            // });
            
            // 
            // function checkAddClickedAreaToArray(e) {
            //     addAreaToClickedAreas(e);
            // }
            
            //TODO: write function to add any CLICKED areas in the image map to an array;

            //DISABLED: old node-based version
            // function addAreaToClickedAreas(e) {
            //     if (!clickedAreas.includes(e.target.id)) {
            //         // if (!clickedAreas.includes(e.target.id) && (e.target.id != '')) {
            //             clickedAreas.push(e.target.id);
            //             console.log(clickedAreas);
            //             checkForCat(e);
            //         } else {
            //             checkForCat(e);
            //     }
            // }
        
            /* 
                Fired when clicking the #startGameButton within the #instructions modal

            */
            function startGame() {
                
                setTimeout(function () {
                    goToBedroomButton.style.display = "block";
                    goToBedroomButton.style.opacity = 1;
                }, 500); // duration of the transition
                document.getElementById("splashPage").style.animation = fadeOut;
                document.getElementById("splashPage").style.display = "none";
                
                // goToLocation("kitchen"); // doesn't work here
                
                // playArea version
                document.getElementById("playArea").style.animation = fadeIn;
                document.getElementById("playArea").style.display = "flex";
                //document.getElementById("playArea")
                
                // imageMap version
                goToKitchenButton.style.display = "none";

                splashPage.remove();
                
                placeCatsRandomly(); // TODO: rewrite this to support the imagemap approach

                runTimer();
            }

            // TODO: Reimplement this with respect to switching to the imagemap clickable area approach
            // this includes adding all of the clickable imagemap areas into an array for easy cross-referencing
            // Randomizes the available clickable areas and adds the first 3 from the
            // randomized array into the catLocations var
            // function placeCatsRandomly() {
            //     const shuffledArray = arrayFromClickables.sort(() => Math.random() - 0.5);
            //     const selectedAreas = shuffledArray.slice(0, totalCats);
            //     console.log(selectedAreas);
            //     // selectedAreas.forEach(area => {
            //     selectedAreas.forEach((area, index, array) => {
            //         catLocations.push(area.id);
            //         var container = document.getElementById(area.id);
            //         // console.log(container);
            //         // container.innerHTML = "<img src='/img/cat1.gif'>";
            //         // container.innerHTML = `<img src='/img/cat${index}.gif'>`; // uses string interpolation // change cat image names starting at cat 0
            //         container.innerHTML = `<img class='catGif' id='cat${index}' src='/img/cat${index}.gif'>`;
            //     });

            //     // console.log('cat 0 id = ' + document.getElementById(0).id);
            //     console.log("Placed cats in the following areas: ", catLocations);
            // }

            // Checks if the area clicked is one of the randomized cat locations
            // Triggers visuals if an unfound cat was found or visually notifies if it was not
            function checkForCat(hidingPlace) {
                if (catLocations.includes(hidingPlace.target.id)) {
                    catsFound++;
                    catsFound++; // TODO: disable, debug only
                    catsFound++; // TODO: disable, debug only
                    document.getElementById("foundCounterValue").innerHTML = catsFound;
                    hidingPlace.target.children[0].style.animation = 'fadeInOut 4s ease-in-out forwards';
                    console.log(`Children of this hidingPlace element: `, hidingPlace.target.children);
                    // document.getElementById(hidingPlace.target.id).style.display = 'none';
                    // document.getElementById(hidingPlace.target.id).style.display = 'block';
                    showNotification("â¤ï¸", hidingPlace.clientX, hidingPlace.clientY);
                } else {
                    showNotification("Darn, no cat here... ðŸ˜Ÿ", hidingPlace.clientX, hidingPlace.clientY);
                }

                if (catsFound >= totalCats) {
                    // gameOver(true); // right now this is handled by the runTimer()
                }
            }            
            
            // Function to show a notification modal at the specified coordinates // TODO: create another for showEmoji
            function showNotification(message, x, y) {
                const notificationModal = document.createElement("div");
                notificationModal.className = "notificationModal";
                notificationModal.style.top = y + "px";
                notificationModal.style.left = x + "px";
                notificationModal.style.zIndex = 7;
                // notificationModal.textContent = message;
                notificationModal.innerHTML = message;

                document.body.appendChild(notificationModal);

                // Triggering the fadeInOut animation after a short delay
                setTimeout(() => {
                    notificationModal.style.animation = fadeInOut;
                    notificationModal.style.position = "fixed"; // Ensure the modal stays fixed relative to the viewport
                    notificationModal.style.width = "auto";
                    notificationModal.style.padding = "10px";
                    notificationModal.style.transform = "translate(-50%, -50%) scale(1.5)"; // Center the modal
                    // Removing the modal after the fade-out animation completes
                    setTimeout(() => {
                        notificationModal.remove();
                    }, 40000); // Adjust the duration based on your fadeInOut animation
                }, 10);
            }

            // TODO: all 3 goToX() functions below need to be reconfigured for updating the
            //  imagemap background images and the clickable areas
            // Changes the 'location' the user is in, including animated crossfade and
            // updating the clickable areas to match the new background room image.
            function goToLocation(location) {
                console.log("goToLocation fired: " + location);
                
                // Apply fade-out animation to the image container
                playArea.style.animation = fadeOut;
                if (location === "bedroom") {
                    goToBedroom();
                    goToBedroomButton.style.display = "none"; // Hides the goToBedroomButton
                    goToKitchenButton.style.animation = fadeIn ;

                    // Change the image source after a delay to synchronize with the fade-out animation
                    setTimeout(function () {
                        document.getElementById("locationImage").src = "img/bedroom.jpg"; // Change the image source after fade-out is complete
                        playArea.style.animation = fadeIn;
                    }, 10);
                    updateClickableAreas("bedroom");
                } else if (location === "kitchen") {
                    goToKitchen();
                    updateClickableAreas("kitchen");
                    goToBedroomButton.style.animation = fadeIn;
                } else {
                    alert("Failed to goToLocation() with an invalid value.");
                }
            }

            function goToKitchen() {
                // Hide the existing goToBedroomButton
                goToKitchenButton.style.display = "none";

                //Hide the existing Bedroom rows
                document.querySelector(".bedroom").style.display = "none";
                //Show the Kitchen rows
                document.querySelector(".kitchen").style.display = "flex";

                // Show the goToKitchenButton after a delay
                setTimeout(function () {
                    goToBedroomButton.style.display = "block";
                }, 500);

                // Change the image source after a delay to synchronize with the fade-out animation
                setTimeout(function () {
                    // Change the image source after fade-out is complete
                    document.getElementById("locationImage").src = "img/kitchen.jpg";
                    
                    // Apply fade-in animation to the image container
                    playArea.style.animation = fadeIn;
                }, 10);

                updateClickableAreas("kitchen");
            }

            function goToBedroom() {
                // Hide the existing goToKitchenButton
                goToBedroomButton.style.display = "none";

                //Hide the existing Kitchen rows
                document.querySelector(".kitchen").style.display = "none";
                //Show the Bedroom rows
                document.querySelector(".bedroom").style.display = "flex";

                // Show the goToKitchenButton after a delay
                setTimeout(function () {
                    goToKitchenButton.style.display = "block";
                }, 500);

                // Change the image source after a delay to synchronize with the fade-out animation
                setTimeout(function () {
                    // Change the image source after fade-out is complete
                    document.getElementById("locationImage").src = "img/bedroom.jpg";

                    // Apply fade-in animation to the image container
                    playArea.style.animation = fadeIn;
                }, 10);

                updateClickableAreas("bedroom");
            }

            // Add functionality to swap the clickable areas of the image.
            function changeImage(location) {
                if (location == "bedroom") {
                    document.getElementById("locationImage").src = "img/bedroom.jpg";
                } else if (location == "kitchen") {
                    document.getElementById("bedroomImage").src = "img/kitchen.jpg";
                }
            }
            
            // Modifies the displayed imagemap displayed over the background image when the location has been updated
            function updateClickableAreas(location) {
                if (location === "bedroom") {
                    
                } else if (location === "kitchen") {

                } else {
                    console.error("updateClickableAreas reveived invalid location param");
                }
            }
            
            // TODO: modify this to remove the imagemap and its interactability
            // function hideClickableAreas() {
            //     const areas = document.querySelectorAll(".area--clickable");
            //     console.log(areas);
            //     areas.forEach(areas => areas.remove());
            // }

            function showInstructions() {
                //addEmojiTargeted(heartEmoji, "50%", "50%"); // TODO: Make this spawn in the splashScreen near the cat's head (i.e. not in the next screen)
                instructions.style.animation = fadeIn;
                instructions.style.display = "block";
                // document.getElementById("instructions").style.display = "block";
                let letsGoButton = document.getElementById("letsGoButton");
                letsGoButton.style.animation = fadeOut;
                
                document.getElementById("startGameContainer").style.animation = fadeIn;
                letsGoButton.remove();
                
            }

            // Function to show a notification modal at the specified coordinates // TODO: finish implementing this; the modal is created but not visible on screen.
            function spawnEmojiAtLocation(message, x, y, layer) {
                const emojiModal = document.createElement("div");
                emojiModal.className = "emojiModal";
                emojiModal.style.top = y + "px";
                emojiModal.style.left = x + "px";
                emojiModal.style.zIndex = 7;
                emojiModal.style.opacity = 0;
                emojiModal.style.display = "none";
                emojiModal.innerHTML = message;

                // document.body.appendChild(emojiModal);
                if (layer == "playArea") {
                    document.getElementById("playArea").appendChild(emojiModal);
                } else if (layer == "splashPage") {
                    document.getElementById("splashPage").appendChild(emojiModal);
                } else {
                    console.error("invalid layer parameter passed to spawnEmojiAtLocation");
                }

                // Triggering the fadeInOut animation after a short delay
                setTimeout(() => {
                    emojiModal.style.animation = fadeInOut;
                    // emojiModal.style.position = "fixed"; // Ensure the modal stays fixed relative to the viewport
                    emojiModal.style.position = "absolute";
                    emojiModal.style.width = "auto";
                    emojiModal.style.padding = "10px";
                    emojiModal.style.transform = "translate(-50%, -50%) scale(2)"; // Center the modal
                    emojiModal.style.display = "block";
                    // Removing the modal after the fade-out animation completes
                    setTimeout(() => {
                        emojiModal.remove();
                    }, 40000); // Duration of the fadeInOut animation
                }, 10);
            }

            // Targets a random place in a container (i.e. playArea or splashPage) and routes flow accordingly
            function addEmojiRandomly(emoji, layer="playArea") {
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;

                const randomX = Math.floor(Math.random() * viewportWidth);
                const randomY = Math.floor(Math.random() * viewportHeight);

                emojiCounter++;
                if (emojiCounter >= maxEmojis) {
                    clearInterval(emojiInterval); // Stop the interval after reaching the desired number of hearts
                }

                clearInterval(emojiInterval); // Stop the interval after reaching the desired number of hearts
                
                spawnEmojiAtLocation(emoji, randomX, randomY, layer);
            }

            // Targets a specific place in a container (i.e. playArea or splashPage) and routes flow accordingly
            function addEmojiTargeted(emoji, X, Y, layer) {
                emojiCounter++;
                if (emojiCounter >= maxEmojis) {
                    clearInterval(emojiInterval); // Stop the interval after reaching the desired number of hearts
                }
                
                if (layer == "playArea") {
                    spawnEmojiAtLocation(emoji, X, Y, "playArea");
                } else if (layer == "splashPage") {
                    spawnEmojiAtLocation(emoji, X, Y, "splashPage");
                }
            }
            
            // TODO: move the catsFound >= totalCats check to checkForCat()
            function runTimer() {
                var interval = window.setInterval(function(){
                    if ((timer <= 0) && (catsFound < totalCats)) {
                        clearInterval(interval);
                        gameOver(false);
                    } else if (catsFound >= totalCats) {
                        // } else if ((timer <= 0) && (catsFound >= totalCats)) {
                        clearInterval(interval);
                        gameOver(true);
                    } else {
                        timer--;
                        document.getElementById("timerValue").innerHTML = timer;
                    };
                }, 1000);
            }
            
            // Resolves the end-state of the program
            function gameOver(outcome) {
                hideClickableAreas(); // TODO: remove the image map from the screen
                if (outcome === true) {
                    successful();
                } else {
                    failure();
                }
            }
            
            // TODO: Change background image to a success image when all cats found
            function successful() {
                var successMessage = document.getElementById("successMessage");
                successMessage.style.display = "block";
                // document.getElementsByClassName.src="img/bedroom.jpg"; // TODO: make it so the background image fades slowly into a full-window real life cat picture
                // document.getElementsByClassName.img = src="img/bedroom.jpg"; // TODO: make it so the background image fades slowly into a full-window real life cat picture
                
                // TODO: Make emojis slowly float up
                // Adds a heart emoji at a random location
                const emojiInterval = setInterval(() => {
                    addEmojiRandomly(heartEmoji);
                },  interval);
            }
            
            // TODO: Show the cats in the unfound places they were hiding
            function failure() {
                var failureMessage = document.getElementById("failureMessage");
                failureMessage.style.display = "block";
                console.log("Failed at the game");
                const emojiInterval = setInterval(() => {
                    addEmojiRandomly(frownEmoji);
                },  interval);
            }
        </script>
    </body>
</html>